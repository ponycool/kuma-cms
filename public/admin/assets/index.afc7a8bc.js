import{h as x,av as i,R as L,u as v,i as T,r as d,bf as D,j as a,B as b,a as y,F as S,aj as C,K as P,bg as q,M as F,bh as O,ad as J,aR as M,bc as B}from"./index.a51be681.js";import{C as E}from"./index.1230655c.js";import{A as w,P as W}from"./index.9fd3886d.js";import{C as j,D as z}from"./DelPopconfirm.f26ebe0f.js";import{D as H}from"./index.f4201d3c.js";import"./index.b59a7255.js";import{c as $}from"./convertNullToUndefined.a19d8223.js";import{f as V}from"./formatDate.c584a859.js";import{T as Z}from"./index.b4bed862.js";import{i as N}from"./index.96ceaae9.js";import{i as G}from"./use-immer.module.6b2bf90e.js";import{I as K}from"./index.485774e5.js";import{I as U}from"./index.12fe7f36.js";import"./index.ecf055c0.js";import"./b-tween.es.064e2a03.js";function Q(l){return x.post("/api/leads/query",l)}function X(l){return x.post("/api/leads/detail",l)}function Y(l){return x.post("/api/leads/create",l)}function ee(l){return x.post("/api/leads/update",l)}function te(l){return x.post("/api/leads/delete",l)}function ae(){return x.post("/api/leads/group/query")}function re(){return x.post("/api/leads/status/query")}function le(){return x.post("/api/leads/assigner/query")}const se=i.Item,R=L.createContext({});function ne(l){const{children:e,record:m,className:o,...s}=l,c=d.exports.useRef(null),h=()=>c.current;return a(R.Provider,{value:{getForm:h},children:a(i,{style:{display:"table-row"},children:e,ref:c,wrapper:"tr",wrapperProps:s})})}function oe(l){const{children:e,className:m,rowData:o,column:s,onHandleSave:c}=l,h=v(T),p=d.exports.useRef(null),r=d.exports.useRef(null),{getForm:n}=d.exports.useContext(R),[t,u]=d.exports.useState(!1),f=d.exports.useCallback(g=>{t&&s.editable&&p.current&&!p.current.contains(g.target)&&!g.target.classList.contains("js-demo-select-option")&&I(o[s.dataIndex])},[t,o,s]);d.exports.useEffect(()=>{t&&r.current&&r.current.focus()},[t]),d.exports.useEffect(()=>(document.addEventListener("click",f,!0),()=>{document.removeEventListener("click",f,!0)}),[f]);const I=g=>{n().validate([s.dataIndex],(_,A)=>{(!_||!_[s.dataIndex])&&(u(!t),c&&c({...o,...A}))})};return t?a("div",{ref:p,children:a(se,{style:{marginBottom:0},labelCol:{span:0},wrapperCol:{span:24},initialValue:o[s.dataIndex],field:s.dataIndex,rules:[{required:s.dataIndex==="name",message:s.dataIndex==="name"?h["editableTable.form.name.required"]:void 0}],children:a(C,{ref:r,onPressEnter:I})})}):a("div",{className:s.editable?`editable-cell ${m}`:m,onClick:()=>{s.editable&&u(!t)},children:e||"-"})}function ie(l){const e=v(T),{lang:m}=d.exports.useContext(D),[o,s]=d.exports.useState([]);function c(r){const n=[...o],t=n.findIndex(u=>r.key===u.key);n.splice(t,1,{...n[t],...r}),s(n)}function h(){s([...o].concat({key:Math.random()*1e3,name:"",phone:""}))}const p=L.useMemo(()=>{const r=[...l.columns];return r.some(n=>n.dataIndex==="option")||r.push({title:e["editableTable.delete"],dataIndex:"option",render:(n,t)=>a(b,{onClick:()=>{s(u=>u.filter(f=>f.key!==t.key))},type:"primary",status:"danger",children:e["editableTable.delete"]})}),r},[o,m]);return d.exports.useEffect(()=>{!o.length&&l.data&&l.data.length&&s(l.data.map(r=>({...r,key:r.key?r.key:Math.random()*1e3})))},[l.data]),d.exports.useEffect(()=>{l.onChange(o)},[o]),y(S,{children:[a(b,{style:{marginBottom:10},type:"primary",onClick:h,children:e["editableTable.create"]}),a(Z,{rowKey:"name",pagination:!1,data:o,components:{body:{row:ne,cell:oe}},columns:p.map(r=>r.editable?{...r,onCell:()=>({onHandleSave:c})}:r)})]})}const de=C.TextArea,{Option:k}=w;function ce(l){var p,r,n;const e=v(N),[m]=i.useForm(),[o,s]=d.exports.useState(!1),c=[{title:e["columns.customerName"],dataIndex:"name",editable:!0},{title:e["columns.phone"],dataIndex:"phone",editable:!0},{title:e["columns.wechat"],dataIndex:"wechat",editable:!0},{title:e["columns.email"],dataIndex:"email",editable:!0}];async function h(){m.validate().then(async t=>{s(!0);try{const u=t.additional_contacts.flatMap(g=>g.name===""?[]:{name:g.name,phone:g.phone,wechat:g.wechat,email:g.email}),f={...t,tags:JSON.stringify(t.tags),additional_contacts:JSON.stringify(u)};let I;l.data?I=await ee({...f,uuid:l.data.uuid}):I=await Y(f),I.code===0&&(l.reload(),l.close())}finally{s(!1)}}).catch(t=>{if(t.errors)for(const u in t.errors)F.error(t.errors[u].message)})}return d.exports.useEffect(()=>{if(l.data){const t=$(l.data);m.setFieldsValue({...t,assigned_at:t.assigned_at?V(new Date(t.assigned_at)):void 0,tags:t.tags&&Array.isArray(JSON.parse(t.tags))?JSON.parse(t.tags):[],additional_contacts:t.additional_contacts&&Array.isArray(JSON.parse(t.additional_contacts))?JSON.parse(t.additional_contacts):[]})}},[l.data]),d.exports.useEffect(()=>{l.visible===!1&&m.resetFields()},[m,l.visible]),a(E,{title:l.data?e["leadsCreate.title.update"]:e["leadsCreate.title.create"],extra:a(P,{style:{cursor:"point",color:"#333",fontSize:"16px"},onClick:()=>l.close()}),actions:[a(b,{type:"default",onClick:()=>l.close(),children:e["leadsCreate.button.cancel"]},"cancel"),a(b,{type:"primary",loading:o,onClick:h,children:l.data?e["leadsCreate.button.save"]:e["leadsCreate.button.create"]},"submit")],children:y(i,{form:m,labelCol:{span:2},wrapperCol:{span:8},children:[a(i.Item,{label:e["leadsCreate.form.companyName.label"],field:"company",children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.companyName.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.customerName.label"],field:"name",children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.customerName.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.phone.label"],field:"phone",rules:[{validator(t,u){t&&!/^[0-9]{11}$/.test(t)&&u(e["leadsCreate.form.phone.required"])}}],children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.phone.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.email.label"],field:"email",rules:[{validator(t,u){t&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t)&&u(e["leadsCreate.form.email.error"])}}],children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.email.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.assigned.label"],field:"assigned_to",children:a(w,{placeholder:e["leadsCreate.form.assigned.placeholder"],children:(p=l.assigner)==null?void 0:p.map(t=>a(k,{value:t,children:t},t))})}),a(i.Item,{label:e["leadsCreate.form.assignedAt.label"],field:"assigned_at",disabled:!0,wrapperCol:{span:2},children:a(H,{})}),a(i.Item,{label:e["leadsCreate.form.source.label"],field:"source",disabled:!0,children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.source.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.tags.label"],field:"tags",children:a(q,{allowClear:!0,placeholder:e["leadsCreate.form.tags.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.registrationEntry.label"],field:"registration_entry",disabled:!0,children:a(C,{maxLength:100,showWordLimit:!0,placeholder:e["leadsCreate.form.registrationEntry.placeholder"]})}),a(i.Item,{label:e["leadsCreate.form.group.label"],field:"group",wrapperCol:{span:2},children:a(w,{placeholder:e["leadsCreate.form.group.placeholder"],children:(r=l.group)==null?void 0:r.map(t=>a(k,{value:t,children:t},t))})}),a(i.Item,{label:e["leadsCreate.form.status.label"],field:"status",wrapperCol:{span:2},children:a(w,{placeholder:e["leadsCreate.form.status.placeholder"],children:(n=l.status)==null?void 0:n.map(t=>a(k,{value:t,children:t},t))})}),a(i.Item,{label:e["leadsCreate.form.additionalContacts.label"],field:"additional_contacts",triggerPropName:"data",wrapperCol:{span:22},children:a(ie,{columns:c})}),a(i.Item,{label:e["leadsCreate.form.description.label"],field:"description",wrapperCol:{span:22},children:a(de,{maxLength:200,placeholder:e["leadsCreate.form.description.placeholder"],showWordLimit:!0,autoSize:!0,style:{minHeight:100}})})]})})}function Le(){const l=v(T),e=v(N),m=O(),o=d.exports.useRef(),[s,c]=G({visible:!1,close:function(){c(r=>{r.visible=!1})},group:[],status:[],assigner:[]});d.exports.useEffect(()=>{s.visible||(ae().then(r=>{r.code===0&&c(n=>{n.group=r.data||[]})}),re().then(r=>{r.code===0&&c(n=>{n.status=r.data||[]})}),le().then(r=>{r.code===0&&c(n=>{n.assigner=r.data||[]})}))},[s.visible]);async function h(r){try{const n=await X({uuid:r});n.code===0&&c(t=>{t.data=n.data,t.visible=!0})}catch{}}const p=[{title:"ID",width:80,dataIndex:"id",sorter:!0},{title:e["columns.companyName"],dataIndex:"company",ellipsis:!0,sorter:!0,search:!0},{title:e["columns.customerName"],dataIndex:"name",sorter:!0,copy:!0},{title:e["columns.phone"],dataIndex:"phone",sorter:!0,copy:!0},{title:e["columns.email"],width:200,dataIndex:"email",sorter:!0,copy:!0},{title:e["columns.group"],dataIndex:"group",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:s.group}},{title:e["columns.assigned"],dataIndex:"assigned_to",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:s.assigner}},{title:e["columns.assignedAt"],dataIndex:"assigned_at",sorter:!0},{title:e["columns.status"],dataIndex:"status",sorter:!0,search:!0,valueType:"select",fieldProps:{options:s.status.map(r=>({label:r,value:r}))}},{title:e["columns.registrationSource"],dataIndex:"registration_source",sorter:!0,search:!0},{title:e["columns.trafficSource"],dataIndex:"traffic_source",sorter:!0,search:!0},{title:e["columns.registrationEntry"],dataIndex:"registration_entry",sorter:!0,search:!0},{title:e["columns.tags"],dataIndex:"tags",render(r,n){if(n.tags&&typeof JSON.parse(n.tags)=="object")return a(J,{children:JSON.parse(n.tags).map(t=>a(M,{children:t},t))})}},{title:e["columns.allocateTime"],dataIndex:"assignedStartTime,assignedEndTime",search:!0,valueType:"date",hide:!0},{title:e["columns.updatedAt"],width:200,dataIndex:"updated_at",sorter:!0},{title:e["columns.updatedAt"],dataIndex:"startTime,endTime",search:!0,valueType:"date",hide:!0},{title:e["columns.keyword"],dataIndex:"keyword",search:!0,hide:!0},{title:e["columns.action"],width:280,fixed:"right",render:(r,n)=>y(j,{children:[y(b,{type:"text",onClick:()=>h(n.uuid),children:[a(B,{}),e["columns.action.edit"]]}),y(b,{type:"text",onClick:()=>{m.push({pathname:"/marketManage/message",search:new URLSearchParams({name:n.name,phone:n.phone,email:n.email}).toString()})},children:[a(K,{}),e["columns.action.message"]]}),a(z,{reqDel:te,params:{uuid:n.uuid},reload:()=>o.current.reload(),children:y(b,{type:"text",children:[a(U,{}),e["columns.action.delete"]]})})]})}];return y(S,{children:[s.visible&&a(ce,{visible:s.visible,data:s.data,close:()=>s.close(),reload:()=>o.current.reload(),group:s.group,status:s.status,assigner:s.assigner}),a(E,{style:{display:s.visible?"none":void 0},children:a(W,{ref:o,request:Q,columns:p,scroll:{x:2500},actionBarRender:[a(b,{type:"primary",onClick:()=>o.current.reload(),children:l["table.refresh"]},"refresh")],toolBarRender:[a(b,{type:"primary",onClick:()=>{c(r=>{r.visible=!0,r.data=void 0})},children:l["table.createClue"]},"create")]})})]})}export{Le as default};
