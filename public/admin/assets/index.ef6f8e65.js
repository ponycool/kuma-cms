import{h as y,aB as l,R as D,r as c,j as t,B as f,a as E,F as A,aj as g,K as S,bf as L,M as T,u as I,i as _,bg as N,ad as R,aR as P,bc as M}from"./index.923808e7.js";import{C as w}from"./index.d8bb5055.js";import{A as b,D as O,P as q}from"./index.3f13cb7e.js";import{i as J,C as W,D as j}from"./use-immer.module.d057e28e.js";import"./index.75ffc5fb.js";import{c as z}from"./convertNullToUndefined.a19d8223.js";import{f as H}from"./formatDate.c584a859.js";import{a as U}from"./index.3cd647fa.js";import{I as K}from"./index.beea2779.js";import{I as V}from"./index.2e4fbc7b.js";import"./index.58d9c8bd.js";function Z(a){return y.post("/api/leads/query",a)}function $(a){return y.post("/api/leads/detail",a)}function G(a){return y.post("/api/leads/create",a)}function Q(a){return y.post("/api/leads/update",a)}function X(a){return y.post("/api/leads/delete",a)}function Y(){return y.post("/api/leads/group/query")}function ee(){return y.post("/api/leads/status/query")}function te(){return y.post("/api/leads/assigner/query")}const ae=l.Item,v=D.createContext({});function ne(a){const{children:n,record:p,className:m,...u}=a,o=c.exports.useRef(null),r=()=>o.current;return t(v.Provider,{value:{getForm:r},children:t(l,{style:{display:"table-row"},children:n,ref:o,wrapper:"tr",wrapperProps:u})})}function ue(a){const{children:n,className:p,rowData:m,column:u,onHandleSave:o}=a,r=c.exports.useRef(null),i=c.exports.useRef(null),{getForm:s}=c.exports.useContext(v),[e,d]=c.exports.useState(!1),x=c.exports.useCallback(h=>{e&&u.editable&&r.current&&!r.current.contains(h.target)&&!h.target.classList.contains("js-demo-select-option")&&C(m[u.dataIndex])},[e,m,u]);c.exports.useEffect(()=>{e&&i.current&&i.current.focus()},[e]),c.exports.useEffect(()=>(document.addEventListener("click",x,!0),()=>{document.removeEventListener("click",x,!0)}),[x]);const C=h=>{s().validate([u.dataIndex],(F,k)=>{(!F||!F[u.dataIndex])&&(d(!e),o&&o({...m,...k}))})};return e?t("div",{ref:r,children:t(ae,{style:{marginBottom:0},labelCol:{span:0},wrapperCol:{span:24},initialValue:m[u.dataIndex],field:u.dataIndex,rules:[{required:u.dataIndex==="name",message:u.dataIndex==="name"?"\u540D\u5B57\u662F\u5FC5\u586B\u9879":void 0}],children:t(g,{ref:i,onPressEnter:C})})}):t("div",{className:u.editable?`editable-cell ${p}`:p,onClick:()=>{u.editable&&d(!e)},children:n||"-"})}function se(a){const[n,p]=c.exports.useState([]);function m(r){const i=[...n],s=i.findIndex(e=>r.key===e.key);i.splice(s,1,{...i[s],...r}),p(i)}function u(){p([...n].concat({key:Math.random()*1e3,name:"",phone:""}))}const o=D.useMemo(()=>{const r=[...a.columns];return r.some(i=>i.dataIndex==="option")||r.push({title:"\u64CD\u4F5C",dataIndex:"option",render:(i,s)=>t(f,{onClick:()=>{p(e=>e.filter(d=>d.key!==s.key))},type:"primary",status:"danger",children:"\u5220\u9664"})}),r},[n]);return c.exports.useEffect(()=>{!n.length&&a.data&&a.data.length&&p(a.data.map(r=>({...r,key:r.key?r.key:Math.random()*1e3})))},[a.data]),c.exports.useEffect(()=>{a.onChange(n)},[n]),E(A,{children:[t(f,{style:{marginBottom:10},type:"primary",onClick:u,children:"\u6DFB\u52A0"}),t(U,{rowKey:"name",pagination:!1,data:n,components:{body:{row:ne,cell:ue}},columns:o.map(r=>r.editable?{...r,onCell:()=>({onHandleSave:m})}:r)})]})}const re=g.TextArea,{Option:B}=b;function le(a){var r,i,s;const[n]=l.useForm(),[p,m]=c.exports.useState(!1),u=[{title:"\u540D\u5B57",dataIndex:"name",editable:!0},{title:"\u7535\u8BDD",dataIndex:"phone",editable:!0},{title:"\u5FAE\u4FE1",dataIndex:"wechat",editable:!0},{title:"\u90AE\u7BB1",dataIndex:"email",editable:!0}];async function o(){n.validate().then(async e=>{m(!0);try{const d=e.additional_contacts.flatMap(h=>h.name===""?[]:{name:h.name,phone:h.phone,wechat:h.wechat,email:h.email}),x={...e,tags:JSON.stringify(e.tags),additional_contacts:JSON.stringify(d)};let C;a.data?C=await Q({...x,uuid:a.data.uuid}):C=await G(x),C.code===0&&(a.reload(),a.close())}finally{m(!1)}}).catch(e=>{if(e.errors)for(const d in e.errors)T.error(e.errors[d].message)})}return c.exports.useEffect(()=>{if(a.data){const e=z(a.data);n.setFieldsValue({...e,assigned_at:e.assigned_at?H(new Date(e.assigned_at)):void 0,tags:e.tags&&Array.isArray(JSON.parse(e.tags))?JSON.parse(e.tags):[],additional_contacts:e.additional_contacts&&Array.isArray(JSON.parse(e.additional_contacts))?JSON.parse(e.additional_contacts):[]})}},[a.data]),c.exports.useEffect(()=>{a.visible===!1&&n.resetFields()},[n,a.visible]),t(w,{title:a.data?"\u4FEE\u6539\u7EBF\u7D22":"\u521B\u5EFA\u7EBF\u7D22",extra:t(S,{style:{cursor:"point",color:"#333",fontSize:"16px"},onClick:()=>a.close()}),actions:[t(f,{type:"default",onClick:()=>a.close(),children:"\u53D6\u6D88"},"cancel"),t(f,{type:"primary",loading:p,onClick:o,children:a.data?"\u4FDD\u5B58":"\u521B\u5EFA"},"submit")],children:E(l,{form:n,labelCol:{span:2},wrapperCol:{span:8},children:[t(l.Item,{label:"\u516C\u53F8\u540D\u79F0",field:"company",children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u516C\u53F8\u540D\u79F0"})}),t(l.Item,{label:"\u5BA2\u6237\u59D3\u540D",field:"name",children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u5BA2\u6237\u540D\u5B57"})}),t(l.Item,{label:"\u624B\u673A\u53F7",field:"phone",children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u624B\u673A\u53F7"})}),t(l.Item,{label:"\u90AE\u7BB1",field:"email",rules:[{validator(e,d){e&&!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e)&&d("\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E")}}],children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u90AE\u7BB1"})}),t(l.Item,{label:"\u8D1F\u8D23\u4EBA",field:"assigned_to",children:t(b,{placeholder:"\u8BBE\u7F6E\u8D1F\u8D23\u4EBA",children:(r=a.assigner)==null?void 0:r.map(e=>t(B,{value:e,children:e},e))})}),t(l.Item,{label:"\u5206\u914D\u65F6\u95F4",field:"assigned_at",disabled:!0,wrapperCol:{span:2},children:t(O,{})}),t(l.Item,{label:"\u6765\u6E90",field:"source",disabled:!0,children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u6765\u6E90"})}),t(l.Item,{label:"\u6807\u7B7E",field:"tags",children:t(L,{allowClear:!0,placeholder:"\u8BF7\u8F93\u5165\u6807\u7B7E\u5E76\u4E14\u56DE\u8F66\u786E\u8BA4"})}),t(l.Item,{label:"\u6CE8\u518C\u5165\u53E3",field:"registration_entry",disabled:!0,children:t(g,{maxLength:100,showWordLimit:!0,placeholder:"\u6CE8\u518C\u5165\u53E3"})}),t(l.Item,{label:"\u5206\u7EC4",field:"group",wrapperCol:{span:2},children:t(b,{placeholder:"\u8BBE\u7F6E\u5206\u7EC4",children:(i=a.group)==null?void 0:i.map(e=>t(B,{value:e,children:e},e))})}),t(l.Item,{label:"\u72B6\u6001",field:"status",wrapperCol:{span:2},children:t(b,{placeholder:"\u8BBE\u7F6E\u72B6\u6001",children:(s=a.status)==null?void 0:s.map(e=>t(B,{value:e,children:e},e))})}),t(l.Item,{label:"\u9644\u52A0\u8054\u7CFB\u65B9\u5F0F",field:"additional_contacts",triggerPropName:"data",wrapperCol:{span:22},children:t(se,{columns:u})}),t(l.Item,{label:"\u5907\u6CE8",field:"description",wrapperCol:{span:22},children:t(re,{maxLength:200,placeholder:"\u5907\u6CE8",showWordLimit:!0,autoSize:!0,style:{minHeight:100}})})]})})}const oe={"en-US":{"columns.companyName":"Company","columns.customerName":"Customer","columns.phone":"Phone","columns.email":"Email","columns.group":"Group","columns.assigned":"Assigned","columns.assignedAt":"AssignedAt","columns.status":"Status","columns.source":"Source","columns.registrationEntry":"Registration","columns.tags":"Tag","columns.allocateTime":"AllocateAt","columns.updatedAt":"UpdateAt","columns.keyword":"Keyword","columns.action":"Action","columns.action.edit":"Edit","columns.action.message":"Message","columns.action.delete":"Delete"},"zh-CN":{"columns.companyName":"\u516C\u53F8\u540D\u79F0","columns.customerName":"\u5BA2\u6237\u59D3\u540D","columns.phone":"\u624B\u673A","columns.email":"\u90AE\u7BB1","columns.group":"\u5206\u7EC4","columns.assigned":"\u8D1F\u8D23\u4EBA","columns.assignedAt":"\u5206\u914D\u65F6\u95F4","columns.status":"\u72B6\u6001","columns.source":"\u6765\u6E90","columns.registrationEntry":"\u6CE8\u518C\u5165\u53E3","columns.tags":"\u6807\u7B7E","columns.allocateTime":"\u5206\u914D\u65F6\u95F4","columns.updatedAt":"\u521B\u5EFA\u65F6\u95F4","columns.keyword":"\u5173\u952E\u8BCD","columns.action":"\u64CD\u4F5C","columns.action.edit":"\u7F16\u8F91","columns.action.message":"\u6D88\u606F","columns.action.delete":"\u5220\u9664"}};function be(){const a=I(_),n=I(oe),p=N(),m=c.exports.useRef(),[u,o]=J({visible:!1,close:function(){o(s=>{s.visible=!1})},group:[],status:[],assigner:[]});c.exports.useEffect(()=>{u.visible||(Y().then(s=>{s.code===0&&o(e=>{e.group=s.data||[]})}),ee().then(s=>{s.code===0&&o(e=>{e.status=s.data||[]})}),te().then(s=>{s.code===0&&o(e=>{e.assigner=s.data||[]})}))},[u.visible]);async function r(s){try{const e=await $({uuid:s});e.code===0&&o(d=>{d.data=e.data,d.visible=!0})}catch{}}const i=[{title:"ID",width:80,dataIndex:"id",sorter:!0},{title:n["columns.companyName"],dataIndex:"company",ellipsis:!0,sorter:!0,search:!0},{title:n["columns.customerName"],dataIndex:"name",sorter:!0,copy:!0},{title:n["columns.phone"],dataIndex:"phone",sorter:!0,copy:!0},{title:n["columns.email"],width:200,dataIndex:"email",sorter:!0,copy:!0},{title:n["columns.group"],dataIndex:"group",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:u.group}},{title:n["columns.assigned"],dataIndex:"assigned_to",sorter:!0,search:!0,valueType:"autoComplete",fieldProps:{data:u.assigner}},{title:n["columns.assignedAt"],dataIndex:"assigned_at",sorter:!0},{title:n["columns.status"],dataIndex:"status",sorter:!0,search:!0,valueType:"select",fieldProps:{options:u.status.map(s=>({label:s,value:s}))}},{title:n["columns.source"],dataIndex:"source",sorter:!0,search:!0},{title:n["columns.registrationEntry"],dataIndex:"registration_entry",sorter:!0,search:!0},{title:n["columns.tags"],dataIndex:"tags",render(s,e){if(e.tags&&typeof JSON.parse(e.tags)=="object")return t(R,{children:JSON.parse(e.tags).map(d=>t(P,{children:d},d))})}},{title:n["columns.allocateTime"],dataIndex:"assignedStartTime,assignedEndTime",search:!0,valueType:"date",hide:!0},{title:n["columns.updatedAt"],width:200,dataIndex:"updated_at",sorter:!0},{title:n["columns.updatedAt"],dataIndex:"startTime,endTime",search:!0,valueType:"date",hide:!0},{title:n["columns.keyword"],dataIndex:"keyword",search:!0,hide:!0},{title:n["columns.action"],width:280,fixed:"right",render:(s,e)=>E(W,{children:[E(f,{type:"text",onClick:()=>r(e.uuid),children:[t(M,{}),n["columns.action.edit"]]}),E(f,{type:"text",onClick:()=>{p.push({pathname:"/marketManage/message",search:new URLSearchParams({name:e.name,phone:e.phone,email:e.email}).toString()})},children:[t(K,{}),n["columns.action.message"]]}),t(j,{reqDel:X,params:{uuid:e.uuid},reload:()=>m.current.reload(),children:E(f,{type:"text",children:[t(V,{}),n["columns.action.delete"]]})})]})}];return E(A,{children:[u.visible&&t(le,{visible:u.visible,data:u.data,close:()=>u.close(),reload:()=>m.current.reload(),group:u.group,status:u.status,assigner:u.assigner}),t(w,{style:{display:u.visible?"none":void 0},children:t(q,{ref:m,request:Z,columns:i,scroll:{x:2500},actionBarRender:[t(f,{type:"primary",onClick:()=>m.current.reload(),children:a["table.refresh"]},"refresh")],toolBarRender:[t(f,{type:"primary",onClick:()=>{o(s=>{s.visible=!0,s.data=void 0})},children:a["table.createClue"]},"create")]})})]})}export{be as default};
